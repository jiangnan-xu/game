<!-- ====== CINEMATIC OPENING + DOOR + ON-DOOR LOCK (drop-in section) ====== -->

<div id="intro">
  <!-- Title layer -->
  <div id="title-layer">
    <div class="title-wrap">
      <div class="kicker">A SMALL WORLD Â· LEVEL 33</div>
      <div class="title">Memory Door</div>
      <div class="subtitle">Scroll to approach the first reality.</div>

      <div class="scroll-indicator" aria-hidden="true">
        <div class="scroll-mouse"></div>
        <div class="scroll-text">Scroll</div>
      </div>
    </div>
  </div>

  <!-- Scene -->
  <div id="scene" aria-label="Door scene">
    <img id="scene-img" src="door-bg.jpg" alt="Door hallway background" />

    <!-- Door hotspots (tune to your image) -->
    <button id="door-hotspot" class="hotspot door" aria-label="Door"></button>
    <button id="bell-hotspot" class="hotspot bell" aria-label="Doorbell"></button>

    <!-- Bell hint (no music UI) -->
    <div id="bell-hint" class="bell-hint">
      Click the doorbell for a hint ðŸŽµ
    </div>

    <!-- On-door lock panel (initially hidden) -->
    <div id="door-lock" class="door-lock" aria-hidden="true">
      <div class="lock-header">
        <div class="lock-title">The door is closed.</div>
        <button id="lock-close" class="lock-close" aria-label="Close lock">âœ•</button>
      </div>

      <div class="lock-sub">
        Enter the first reality code.
      </div>

      <div id="lock-wheels" class="lock-wheels"></div>

      <div class="lock-actions">
        <button id="unlock-btn" class="btn-primary">Unlock</button>
      </div>

      <div id="hint-message" class="hint-message"></div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Atmosphere layer -->
    <div class="grain"></div>
    <div class="dust" aria-hidden="true"></div>
    <div class="vignette"></div>
  </div>
</div>

<!-- audio (no controls) -->
<audio id="hint-audio" src="song.m4a" preload="auto"></audio>

<style>
  /* ===== Layout ===== */
  #intro{
    position: fixed;
    inset: 0;
    background: #000;
    overflow: hidden;
    z-index: 9999;
    font-family: "Nunito", system-ui, sans-serif;
  }

  #scene{
    position:absolute;
    inset:0;
    opacity:0;
    transition: opacity 500ms ease;
  }

  #scene-img{
    width:100%;
    height:100%;
    object-fit: cover;
    transform-origin: 50% 50%;
    will-change: transform;
    user-select:none;
    -webkit-user-drag:none;
  }

  /* ===== Title (cinematic) ===== */
  #title-layer{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    text-align:center;
    pointer-events:none;
    z-index: 3;
    transition: opacity 400ms ease;
    background:
      radial-gradient(circle at 50% 35%, rgba(255,255,255,0.10), rgba(0,0,0,0.85) 60%),
      linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0.80));
  }

  .title-wrap{
    width:min(760px, 92vw);
    padding: 24px 18px;
  }

  .kicker{
    letter-spacing: .28em;
    text-transform: uppercase;
    font-size: 12px;
    opacity: .75;
    margin-bottom: 12px;
  }

  .title{
    font-family: "Zen Maru Gothic", system-ui, sans-serif;
    font-size: clamp(42px, 6vw, 64px);
    font-weight: 800;
    line-height: 1.05;
    text-shadow: 0 18px 60px rgba(0,0,0,0.65);
  }

  .subtitle{
    margin-top: 12px;
    font-size: 15px;
    opacity: .78;
    line-height: 1.6;
  }

  .scroll-indicator{
    margin-top: 22px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    opacity:.9;
  }
  .scroll-mouse{
    width: 22px;
    height: 34px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.45);
    position: relative;
  }
  .scroll-mouse::after{
    content:"";
    position:absolute;
    left:50%;
    top: 7px;
    width: 3px;
    height: 6px;
    border-radius: 999px;
    background: rgba(255,255,255,0.65);
    transform: translateX(-50%);
    animation: wheel 1.2s ease-in-out infinite;
  }
  @keyframes wheel{
    0%{ opacity:.2; transform: translateX(-50%) translateY(0); }
    50%{ opacity:1; }
    100%{ opacity:.2; transform: translateX(-50%) translateY(10px); }
  }
  .scroll-text{ font-size: 12px; opacity:.7; letter-spacing:.12em; }

  /* ===== Hotspots ===== */
  .hotspot{
    position:absolute;
    border:none;
    background: rgba(255,255,255,0);
    cursor: pointer;
    z-index: 4;
  }

  /* tune to your image */
  #door-hotspot{ left: 34%; top: 18%; width: 28%; height: 66%; }
  #bell-hotspot{ left: 56%; top: 43%; width: 6%; height: 10%; }

  /* ===== Bell hint ===== */
  .bell-hint{
    position:absolute;
    left: calc(56% + 7%);
    top: calc(43% + 1%);
    transform: translateY(-50%);
    padding: 10px 12px;
    border-radius: 999px;
    color: rgba(255,255,255,0.92);
    background: rgba(0,0,0,0.45);
    border: 1px solid rgba(255,255,255,0.20);
    box-shadow: 0 16px 60px rgba(0,0,0,0.55);
    font-size: 13px;
    z-index: 6;
    backdrop-filter: blur(6px);
    pointer-events:none;
  }

  /* ===== On-door Lock Panel ===== */
  .door-lock{
    position:absolute;
    left: 50%;
    top: 38%;
    transform: translate(-50%, -50%);
    width: min(460px, 92vw);
    border-radius: 18px;
    padding: 14px 14px 12px;
    background: rgba(255,255,255,0.90);
    border: 1px solid rgba(255,255,255,0.45);
    box-shadow: 0 30px 90px rgba(0,0,0,0.40);
    z-index: 7;
    display:none;
    backdrop-filter: blur(10px);
  }
  .door-lock.show{ display:block; }

  .lock-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom: 6px;
  }
  .lock-title{
    font-family:"Zen Maru Gothic", system-ui, sans-serif;
    font-weight: 800;
    font-size: 16px;
    color:#111827;
  }
  .lock-close{
    border:none;
    background: rgba(17,24,39,0.06);
    border: 1px solid rgba(17,24,39,0.10);
    width: 34px;
    height: 34px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 900;
  }
  .lock-sub{
    font-size: 13px;
    color:#374151;
    margin-bottom: 10px;
  }

  /* Wheels (same feel as your original, compact) */
  .lock-wheels{
    display:flex;
    justify-content:center;
    gap:12px;
    margin: 10px 0 6px;
    user-select:none;
    -webkit-user-select:none;
    touch-action: pan-y;
  }
  .wheel{
    width: 54px;
    height: 78px;
    border-radius: 16px;
    background: linear-gradient(180deg, #eff6ff 0, #dbeafe 100%);
    border: 1px solid #bfdbfe;
    box-shadow: 0 12px 26px rgba(148,163,184,0.55);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
    cursor: grab;
  }
  .wheel:active{ cursor: grabbing; }
  .wheel::before, .wheel::after{
    content:"";
    position:absolute;
    left:0; right:0;
    height: 22px;
    pointer-events:none;
  }
  .wheel::before{ top:0; background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0)); }
  .wheel::after { bottom:0; background: linear-gradient(0deg, rgba(255,255,255,0.95), rgba(255,255,255,0)); }
  .wheel .window-line{
    position:absolute;
    left:8px; right:8px;
    height: 2px;
    top: 50%;
    transform: translateY(-1px);
    background: rgba(59,130,246,0.25);
    border-radius: 999px;
    pointer-events:none;
  }
  .wheel-letter{
    font-family: "Zen Maru Gothic", system-ui, sans-serif;
    font-size: 26px;
    font-weight: 800;
    color:#111827;
    transition: transform 0.06s ease;
    will-change: transform;
  }

  .lock-actions{
    display:flex;
    justify-content:center;
    margin-top: 10px;
  }
  .btn-primary{
    border:none;
    border-radius: 999px;
    padding: 10px 18px;
    cursor:pointer;
    font-weight: 900;
    background: linear-gradient(135deg, #fde68a, #fb923c);
  }

  .hint-message{
    margin-top: 10px;
    min-height: 18px;
    font-weight: 900;
    color: #b91c1c;
  }

  /* ===== Toast ===== */
  .toast{
    position:absolute;
    left:50%;
    bottom: 36px;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.60);
    color:#fff;
    padding: 10px 14px;
    border-radius: 999px;
    font-size: 14px;
    opacity: 0;
    pointer-events:none;
    transition: opacity 180ms ease, transform 180ms ease;
    z-index: 8;
    backdrop-filter: blur(6px);
  }
  .toast.show{
    opacity: 1;
    transform: translateX(-50%) translateY(-6px);
  }

  /* ===== Atmosphere overlays ===== */
  .vignette{
    position:absolute; inset:0;
    background: radial-gradient(circle at 50% 40%, rgba(0,0,0,0.0), rgba(0,0,0,0.55));
    pointer-events:none;
    z-index: 2;
  }
  .grain{
    position:absolute; inset:0;
    pointer-events:none;
    z-index: 2;
    opacity:.12;
    background-image:
      repeating-linear-gradient(0deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 1px, transparent 1px, transparent 2px);
    mix-blend-mode: overlay;
  }
  .dust{
    position:absolute; inset:-20%;
    pointer-events:none;
    z-index: 2;
    opacity:.55;
    background:
      radial-gradient(circle at 20% 30%, rgba(255,255,255,0.10), transparent 40%),
      radial-gradient(circle at 70% 60%, rgba(255,255,255,0.10), transparent 42%),
      radial-gradient(circle at 40% 80%, rgba(255,255,255,0.08), transparent 38%);
    filter: blur(0.2px);
    animation: drift 8s ease-in-out infinite alternate;
  }
  @keyframes drift{
    from{ transform: translate3d(-6px,-6px,0); }
    to  { transform: translate3d(8px,10px,0); }
  }
</style>

<script>
  // ========= CONFIG =========
  const CORRECT_CODE = "REALITY";
  const NUM_WHEELS = 7;
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

  // Where the camera should end up (tune for your image)
  const DOOR_FOCUS = { x: 0.44, y: 0.52 };
  const ZOOM_MIN = 1.0;
  const ZOOM_MAX = 2.6;

  // ========= ELEMENTS =========
  const titleLayer = document.getElementById("title-layer");
  const scene = document.getElementById("scene");
  const sceneImg = document.getElementById("scene-img");

  const doorHotspot = document.getElementById("door-hotspot");
  const bellHotspot = document.getElementById("bell-hotspot");

  const bellHint = document.getElementById("bell-hint");
  const toast = document.getElementById("toast");

  const doorLock = document.getElementById("door-lock");
  const lockClose = document.getElementById("lock-close");
  const unlockBtn = document.getElementById("unlock-btn");
  const hintMessage = document.getElementById("hint-message");
  const lockWheelsContainer = document.getElementById("lock-wheels");

  const hintAudio = document.getElementById("hint-audio");

  // ========= STATE =========
  let progress = 0;           // 0..1 controls reveal + zoom
  let rafPending = false;
  let lockOpen = false;       // IMPORTANT: when true, bg must not zoom on wheel

  // ========= HELPERS =========
  function clamp01(v){ return Math.max(0, Math.min(1, v)); }

  let toastT = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toastT);
    toastT = setTimeout(() => toast.classList.remove("show"), 900);
  }

  function applyCamera(){
    // Title fades out, scene fades in
    const sceneAlpha = clamp01((progress - 0.05) / 0.25);
    scene.style.opacity = sceneAlpha.toFixed(3);
    titleLayer.style.opacity = (1 - sceneAlpha).toFixed(3);

    // Zoom/pan toward the door as progress increases
    const t = clamp01((progress - 0.10) / 0.90);
    const zoom = ZOOM_MIN + (ZOOM_MAX - ZOOM_MIN) * (t * t);

    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const offsetX = (0.5 - DOOR_FOCUS.x) * vw * (zoom - 1);
    const offsetY = (0.5 - DOOR_FOCUS.y) * vh * (zoom - 1);

    sceneImg.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${zoom})`;
  }

  function requestApply(){
    if (rafPending) return;
    rafPending = true;
    requestAnimationFrame(() => {
      rafPending = false;
      applyCamera();
    });
  }

  // ========= SCROLL CONTROL (disabled when lock is open) =========
  window.addEventListener("wheel", (e) => {
    if (lockOpen) {
      // Lock UI open: DO NOT zoom background; allow wheel to affect only the wheels (inside lock)
      return;
    }
    e.preventDefault();
    const delta = -e.deltaY;
    progress = clamp01(progress + delta * 0.0007);
    requestApply();
  }, { passive: false });

  window.addEventListener("resize", requestApply);
  applyCamera();

  // ========= AUDIO (only on doorbell click) =========
  function playHintSong(){
    try{
      hintAudio.currentTime = 0;
      hintAudio.play().catch(()=>{});
    }catch(_){}
  }

  bellHotspot.addEventListener("click", () => {
    showToast("ðŸ”” Ding...");
    playHintSong();
    // subtle feedback: fade hint a bit after first click
    bellHint.style.opacity = "0.75";
  });

  // ========= ON-DOOR LOCK UI =========
  function openLock(){
    lockOpen = true;
    doorLock.classList.add("show");
    doorLock.setAttribute("aria-hidden", "false");
  }
  function closeLock(){
    lockOpen = false;
    doorLock.classList.remove("show");
    doorLock.setAttribute("aria-hidden", "true");
    hintMessage.textContent = "";
  }
  lockClose.addEventListener("click", closeLock);

  // Door click: show â€œclosedâ€ + lock on the door
  doorHotspot.addEventListener("click", () => {
    showToast("The door is closed.");
    openLock();
  });

  // ========= LETTER LOCK =========
  const wheelPositions = new Array(NUM_WHEELS).fill(0);

  function clampWheel(i){
    if (i < 0) return letters.length - 1;
    if (i >= letters.length) return 0;
    return i;
  }
  function getEnteredCode(){
    return wheelPositions.map((pos) => letters[pos]).join("");
  }

  function createScrollWheel(index){
    const wheel = document.createElement("div");
    wheel.className = "wheel";

    const windowLine = document.createElement("div");
    windowLine.className = "window-line";

    const letterEl = document.createElement("div");
    letterEl.className = "wheel-letter";
    letterEl.textContent = letters[wheelPositions[index]];

    function step(direction){
      wheelPositions[index] = clampWheel(wheelPositions[index] + direction);
      letterEl.textContent = letters[wheelPositions[index]];
      letterEl.style.transform = `translateY(${direction > 0 ? -8 : 8}px)`;
      setTimeout(() => (letterEl.style.transform = "translateY(0)"), 60);
    }

    // wheel scroll changes letters
    wheel.addEventListener("wheel", (e) => {
      e.preventDefault();
      const direction = e.deltaY > 0 ? -1 : 1;
      step(direction);
    }, { passive:false });

    // drag / swipe
    const STEP_PX = 14;
    let dragging = false, lastY = 0, accumulatedDy = 0;

    wheel.addEventListener("pointerdown", (e) => {
      dragging = true;
      wheel.setPointerCapture(e.pointerId);
      lastY = e.clientY;
      accumulatedDy = 0;
      e.preventDefault();
    });

    wheel.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      e.preventDefault();
      const dy = e.clientY - lastY;
      lastY = e.clientY;
      accumulatedDy += dy;

      while (accumulatedDy <= -STEP_PX) { step(+1); accumulatedDy += STEP_PX; }
      while (accumulatedDy >=  STEP_PX) { step(-1); accumulatedDy -= STEP_PX; }
    });

    function endDrag(){ dragging = false; accumulatedDy = 0; }
    wheel.addEventListener("pointerup", endDrag);
    wheel.addEventListener("pointercancel", endDrag);
    wheel.addEventListener("pointerleave", endDrag);

    wheel.appendChild(windowLine);
    wheel.appendChild(letterEl);
    return wheel;
  }

  // init wheels
  lockWheelsContainer.innerHTML = "";
  for (let i=0; i<NUM_WHEELS; i++){
    lockWheelsContainer.appendChild(createScrollWheel(i));
  }

  // unlock
  unlockBtn.addEventListener("click", () => {
    const entered = getEnteredCode();
    if (entered === CORRECT_CODE){
      hintMessage.textContent = "";
      showToast("Unlocked.");
      closeLock();

      // Hook your next scene here (e.g. reveal your map overlay / step 2)
      // Example:
      // document.getElementById("intro").style.display = "none";
      // document.getElementById("hint-overlay").style.display = "none";
    } else {
      hintMessage.textContent = "Not quiteâ€¦";
    }
  });
</script>
