<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Find the Last Piece of Memory</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Soft RPG / anime-ish fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at top, #dbeafe 0, #eff6ff 35%, #e5e7eb 100%);
      font-family: "Nunito", system-ui, sans-serif;
    }
    #map { height: 100%; width: 100%; }

    h2 {
      position: absolute;
      z-index: 1000;
      background: linear-gradient(135deg, rgba(191,219,254,0.95), rgba(236,252,203,0.98));
      padding: 12px 22px;
      margin: 10px;
      border-radius: 999px;
      font-size: 17px;
      color: #1f2937;
      box-shadow: 0 8px 24px rgba(15,23,42,0.25);
      border: 1px solid rgba(59,130,246,0.35);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    h2 span.label {
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
      font-size: 13px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(59,130,246,0.1);
      color: #1d4ed8;
    }

    .leaflet-container {
      background: #bfdbfe;
      font-family: "Nunito", system-ui, sans-serif;
    }

    #hint-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(191,219,254,0.9) 0, rgba(219,234,254,0.95) 40%, rgba(239,246,255,0.95) 100%);
      color: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    .hint-card {
      background: rgba(255,255,255,0.96);
      border-radius: 24px;
      padding: 26px 26px 22px;
      max-width: 560px;
      width: 92%;
      box-shadow: 0 24px 60px rgba(15,23,42,0.25);
      border: 1px solid rgba(96,165,250,0.7);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hint-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 10% 0%, rgba(248,250,252,0.9), transparent 60%);
      pointer-events: none;
    }
    .hint-title {
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1d4ed8;
    }
    .hint-subtitle {
      font-size: 17px;
      color: #374151;
      margin-bottom: 16px;
      line-height: 1.7;
    }
    .hint-subtitle span.em {
      color: #f97316;
      font-weight: 800;
    }
    .hint-audio-wrapper {
      margin-bottom: 18px;
      padding: 12px 12px 10px;
      border-radius: 16px;
      background: rgba(239,246,255,0.9);
      border: 1px solid rgba(191,219,254,1);
    }
    .hint-audio-label {
      font-size: 15px;
      color: #4b5563;
      margin-bottom: 6px;
    }

    /* ‚úÖ ÊªëÊªöÂºèÂ≠óÊØçÈîÅ */
    .lock-wheels{
      display:flex;
      justify-content:center;
      gap:12px;
      margin:14px 0 8px;
      user-select:none;
      -webkit-user-select:none;
      touch-action: pan-y;
    }
    .wheel{
      width: 54px;
      height: 78px;
      border-radius: 16px;
      background: linear-gradient(180deg, #eff6ff 0, #dbeafe 100%);
      border: 1px solid #bfdbfe;
      box-shadow: 0 12px 26px rgba(148,163,184,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      cursor: grab;
    }
    .wheel:active{ cursor: grabbing; }
    .wheel::before, .wheel::after{
      content:"";
      position:absolute;
      left:0; right:0;
      height: 22px;
      pointer-events:none;
    }
    .wheel::before{
      top:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0));
    }
    .wheel::after{
      bottom:0;
      background: linear-gradient(0deg, rgba(255,255,255,0.95), rgba(255,255,255,0));
    }
    .wheel .window-line{
      position:absolute;
      left:8px; right:8px;
      height: 2px;
      top: 50%;
      transform: translateY(-1px);
      background: rgba(59,130,246,0.25);
      border-radius: 999px;
      pointer-events:none;
    }
    .wheel-letter{
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
      font-size: 26px;
      font-weight: 800;
      color:#111827;
      transition: transform 0.06s ease;
      will-change: transform;
    }
    .wheel-hint{
      font-size: 12px;
      color:#6b7280;
      margin-top: 8px;
    }

    .hint-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 15px;
      cursor: pointer;
      font-weight: 800;
      font-family: "Nunito", system-ui, sans-serif;
      letter-spacing: 0.04em;
    }
    .btn-primary {
      background: linear-gradient(135deg, #fb923c, #facc15);
      color: #111827;
      box-shadow: 0 8px 18px rgba(251,146,60,0.4);
    }
    .btn-secondary {
      background: #eff6ff;
      color: #1f2937;
      border: 1px solid #bfdbfe;
    }
    .btn:disabled { opacity: 0.55; cursor: default; box-shadow: none; }

    .hint-message {
      font-size: 16px;
      min-height: 22px;
      margin-top: 10px;
      font-weight: 800;
    }
    .hint-message.error { color: #b91c1c; }

    /* Step 2: coordinate search */
    #hint-step-text { display: none; }

    .coord-card {
      margin-top: 8px;
      padding: 14px 14px 12px;
      border-radius: 18px;
      background: rgba(239,246,255,0.9);
      border: 1px solid rgba(191,219,254,1);
      text-align: left;
    }
    .coord-title {
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
      font-weight: 800;
      color: #1d4ed8;
      margin-bottom: 10px;
      font-size: 16px;
      text-align: center;
    }
    .coord-line {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .coord-bubble {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 16px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(147,197,253,0.9);
      color: #111827;
    }
    .coord-input {
      width: 92px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 16px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(147,197,253,0.9);
      outline: none;
      background: white;
      text-align: center;
    }
    .coord-input:focus {
      box-shadow: 0 0 0 4px rgba(59,130,246,0.18);
      border-color: rgba(59,130,246,0.65);
    }

    .coord-help {
      font-size: 13px;
      color: #374151;
      line-height: 1.55;
      margin-top: 8px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(147,197,253,0.9);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .coord-help b { color: #1d4ed8; }

    .result-box {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(147,197,253,0.9);
      color: #111827;
      font-size: 14px;
      line-height: 1.55;
      display: none;
    }
    .result-box.bad  { border-color: rgba(248,113,113,0.8); }
    .result-box.good { border-color: rgba(74,222,128,0.85); }
    .result-title {
      font-weight: 900;
      margin-bottom: 6px;
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
    }
    .result-photos {
      margin-top: 10px;
      display: none;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .result-photos img {
      max-width: 230px;
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(191,219,254,0.9);
      box-shadow: 0 14px 36px rgba(15,23,42,0.18);
    }

    /* Marker bubbles */
    .guess-icon {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.85);
      box-shadow: 0 12px 26px rgba(15,23,42,0.35);
    }
    .guess-good { background: radial-gradient(circle at 30% 0%, #bbf7d0 0, #22c55e 60%, #16a34a 100%); }
    .guess-bad  { background: radial-gradient(circle at 30% 0%, #fecaca 0, #ef4444 60%, #b91c1c 100%); }

    /* Win overlay */
    #win-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(191,219,254,0.65), rgba(243,244,246,0.9));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
    }
    .win-card {
      background: rgba(255,255,255,0.98);
      border-radius: 24px;
      padding: 26px 24px 22px;
      max-width: 460px;
      width: 92%;
      text-align: center;
      border: 1px solid rgba(129,140,248,0.7);
      box-shadow: 0 24px 60px rgba(15,23,42,0.3);
      color: #111827;
      position: relative;
      overflow: hidden;
    }
    .win-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 10% 0%, rgba(239,246,255,0.8), transparent 60%);
      pointer-events: none;
    }
    .win-emoji { font-size: 36px; margin-bottom: 10px; }
    .win-title {
      font-size: 20px;
      font-weight: 900;
      margin-bottom: 8px;
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
    }
    .win-subtitle {
      font-size: 16px;
      color: #374151;
      margin-bottom: 14px;
      line-height: 1.7;
    }
    .win-place {
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      margin-bottom: 12px;
      color: #1f2937;
      font-weight: 800;
    }
    .win-images {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .win-images img {
      max-width: 230px;
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(191,219,254,0.9);
      box-shadow: 0 14px 36px rgba(15,23,42,0.18);
    }
    .win-note {
      font-size: 15px;
      color: #4b5563;
      margin-top: 10px;
      line-height: 1.6;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <h2>
    <span class="label">Memory Quest</span>
    Search the missing coordinate prefixes to reveal the place‚Ä¶
  </h2>

  <div id="map"></div>

  <!-- üîê Opening hint / lock screen -->
  <div id="hint-overlay">
    <div class="hint-card">

      <!-- STEP 1: music + lock -->
      <div id="hint-step-lock">
        <div class="hint-title">Prologue ¬∑ The Sealed Memory</div>
        <div class="hint-subtitle">
          Listen‚Ä¶ and unlock the word.<br/>
          Then the coordinate riddles will appear.
        </div>

        <div class="hint-audio-wrapper">
          <div class="hint-audio-label">This audio might help üéµ</div>
          <audio id="hint-audio" src="song.m4a" controls preload="auto"></audio>
        </div>

        <div id="lock-wheels" class="lock-wheels"></div>
        <div class="wheel-hint">Tip: scroll / swipe each wheel (mouse wheel works too).</div>

        <div class="hint-buttons">
          <button id="unlock-btn" class="btn btn-primary">Unlock</button>
        </div>

        <div id="hint-message" class="hint-message"></div>
      </div>

      <!-- STEP 2: coordinate puzzle -->
      <div id="hint-step-text">
        <div class="hint-title">Clue Unlocked ¬∑ Coordinate Riddles</div>

        <div class="coord-card">
          <div class="coord-title">Complete the Coordinates</div>

          <div class="coord-line">
            <span class="coord-bubble">Lat</span>
            <input id="lat-prefix" class="coord-input" inputmode="numeric" maxlength="2" placeholder="??" />
            <span class="coord-bubble">.442006</span>
            <span class="coord-bubble">,</span>
            <span class="coord-bubble">Lng</span>
            <input id="lng-prefix" class="coord-input" inputmode="numeric" maxlength="3" placeholder="???" />
            <span class="coord-bubble">.630649</span>
          </div>

          <div class="hint-buttons" style="margin-top: 6px;">
            <button id="search-btn" class="btn btn-primary">Search on Map</button>
            <button id="start-btn" class="btn btn-secondary">Begin the journey</button>
          </div>

          <!-- ‚úÖ YOUR CUSTOM HARDCORE CLUES HERE -->
          <div class="coord-help">
            <b>Latitude prefix (2 digits):</b><br/>
            ‚ÄúYour favorite paper ‚Äî the number you see before <i>‚Äòessentially.‚Äô</i>‚Äù<br/><br/>
            <b>Longitude prefix (3 digits):</b><br/>
            ‚ÄúProf. Kim entered a classroom with 8 seats in a row. From left to right,
            the 2nd‚Äì4th seats are empty, the 6th one is also empty, but the others are full.‚Äù<br/>
            (binary: <b>10001011</b>)
          </div>

          <div id="result-box" class="result-box">
            <div id="result-title" class="result-title"></div>
            <div id="result-text"></div>

            <div id="result-photos" class="result-photos">
              <img src="place.png" alt="The real place photo (place.png)" />
              <img src="win.png" alt="Winning image (win.png)" />
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- üéâ Win overlay -->
  <div id="win-overlay">
    <div class="win-card">
      <div class="win-emoji">üéÇüéâüéÅ</div>
      <div class="win-title">You found it!</div>
      <div class="win-subtitle">
        The last piece of memory has finally come home.
      </div>
      <div class="win-place" id="win-place"></div>

      <div class="win-images">
        <img src="place.png" alt="The real place photo (place.png)" />
        <img src="win.png" alt="Winning image (win.png)" />
      </div>

      <div class="win-note">
        I‚Äôll give you the physical gift in person.<br/>
        Thank you for playing through this little world I made for you. ‚ú®
      </div>
    </div>
  </div>

  <audio id="gift-sound" src="win.m4a" preload="auto"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ============================
    // 1) ÊªëÊªö Letter lock logic
    // ============================
    const CORRECT_CODE = "REALITY";
    const NUM_WHEELS = 7;
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    const lockWheelsContainer = document.getElementById("lock-wheels");
    const unlockBtn = document.getElementById("unlock-btn");
    const startBtn = document.getElementById("start-btn");
    const hintMessage = document.getElementById("hint-message");
    const hintOverlay = document.getElementById("hint-overlay");
    const hintAudio = document.getElementById("hint-audio");

    const hintStepLock = document.getElementById("hint-step-lock");
    const hintStepText = document.getElementById("hint-step-text");

    const wheelPositions = new Array(NUM_WHEELS).fill(0);

    function clampWheel(i) {
      if (i < 0) return letters.length - 1;
      if (i >= letters.length) return 0;
      return i;
    }

    function getEnteredCode() {
      return wheelPositions.map((pos) => letters[pos]).join("");
    }

    function showHintMessage(text, type) {
      hintMessage.textContent = text;
      hintMessage.classList.remove("error", "success");
      if (type) hintMessage.classList.add(type);
    }

    function createScrollWheel(index) {
      const wheel = document.createElement("div");
      wheel.className = "wheel";

      const windowLine = document.createElement("div");
      windowLine.className = "window-line";

      const letterEl = document.createElement("div");
      letterEl.className = "wheel-letter";
      letterEl.textContent = letters[wheelPositions[index]];

      function step(direction) {
        wheelPositions[index] = clampWheel(wheelPositions[index] + direction);
        letterEl.textContent = letters[wheelPositions[index]];
        letterEl.style.transform = `translateY(${direction > 0 ? -8 : 8}px)`;
        setTimeout(() => (letterEl.style.transform = "translateY(0)"), 60);
      }

      wheel.addEventListener("wheel", (e) => {
        e.preventDefault();
        const direction = e.deltaY > 0 ? -1 : 1;
        step(direction);
      }, { passive: false });

      const STEP_PX = 14;
      let dragging = false;
      let lastY = 0;
      let accumulatedDy = 0;

      wheel.addEventListener("pointerdown", (e) => {
        dragging = true;
        wheel.setPointerCapture(e.pointerId);
        lastY = e.clientY;
        accumulatedDy = 0;
        e.preventDefault();
      });

      wheel.addEventListener("pointermove", (e) => {
        if (!dragging) return;
        e.preventDefault();

        const dy = e.clientY - lastY;
        lastY = e.clientY;
        accumulatedDy += dy;

        while (accumulatedDy <= -STEP_PX) {
          step(+1);
          accumulatedDy += STEP_PX;
        }
        while (accumulatedDy >= STEP_PX) {
          step(-1);
          accumulatedDy -= STEP_PX;
        }
      });

      function endDrag() {
        dragging = false;
        accumulatedDy = 0;
      }

      wheel.addEventListener("pointerup", endDrag);
      wheel.addEventListener("pointercancel", endDrag);
      wheel.addEventListener("pointerleave", endDrag);

      wheel.appendChild(windowLine);
      wheel.appendChild(letterEl);
      return wheel;
    }

    for (let i = 0; i < NUM_WHEELS; i++) {
      lockWheelsContainer.appendChild(createScrollWheel(i));
    }

    unlockBtn.addEventListener("click", () => {
      const entered = getEnteredCode();
      if (entered === CORRECT_CODE) {
        showHintMessage("", null);
        hintStepLock.style.display = "none";
        hintStepText.style.display = "block";
      } else {
        showHintMessage("Not quite‚Ä¶ try again.", "error");
      }
    });

    startBtn.addEventListener("click", () => {
      hintOverlay.style.display = "none";
      try { hintAudio.pause(); } catch (_) {}
    });

    // ============================
    // 2) Map + Coordinate Search logic
    // ============================
    const targetRestaurant = {
      name: "Ramen Jiro Yokohama Kannai",
      lat: 35.442006,
      lng: 139.630649
    };

    const map = L.map("map", {
      minZoom: 2,
      maxZoom: 18,
      worldCopyJump: false,
      maxBounds: [[-90, -180],[90, 180]],
      maxBoundsViscosity: 1.0
    }).setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      noWrap: true,
      continuousWorld: false,
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    const giftSound = document.getElementById("gift-sound");
    const winOverlay = document.getElementById("win-overlay");
    const winPlace = document.getElementById("win-place");

    const latPrefixEl = document.getElementById("lat-prefix");
    const lngPrefixEl = document.getElementById("lng-prefix");
    const searchBtn = document.getElementById("search-btn");

    const resultBox = document.getElementById("result-box");
    const resultTitle = document.getElementById("result-title");
    const resultText = document.getElementById("result-text");
    const resultPhotos = document.getElementById("result-photos");

    let activeGuessMarker = null;
    let giftFound = false;

    function playWinSound() {
      if (!giftSound) return;
      try {
        giftSound.currentTime = 0;
        giftSound.play().catch(() => {});
      } catch (_) {}
    }

    function lockMap() {
      map.dragging.disable();
      map.touchZoom.disable();
      map.doubleClickZoom.disable();
      map.scrollWheelZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
      if (map.zoomControl) map.zoomControl.remove();
    }

    function setResult(type, title, text, showPics) {
      resultBox.style.display = "block";
      resultBox.classList.remove("bad", "good");
      resultBox.classList.add(type === "good" ? "good" : "bad");
      resultTitle.textContent = title;
      resultText.textContent = text;
      resultPhotos.style.display = showPics ? "flex" : "none";
    }

    function clearGuessMarker() {
      if (activeGuessMarker && map.hasLayer(activeGuessMarker)) map.removeLayer(activeGuessMarker);
      activeGuessMarker = null;
    }

    function makeGuessIcon(isGood) {
      return L.divIcon({
        className: "",
        html: `<div class="guess-icon ${isGood ? "guess-good" : "guess-bad"}">${isGood ? "‚ú®" : "‚ùå"}</div>`,
        iconSize: [42, 42],
        iconAnchor: [21, 42]
      });
    }

    function randomLatLngNotNear(targetLat, targetLng) {
      for (let tries = 0; tries < 60; tries++) {
        const lat = (Math.random() * 170) - 85;
        const lng = (Math.random() * 360) - 180;
        const dLat = lat - targetLat;
        const dLng = lng - targetLng;
        const dist = Math.sqrt(dLat*dLat + dLng*dLng);
        if (dist > 10) return { lat, lng };
      }
      return { lat: 0, lng: 0 };
    }

    function isCorrectGuess(lat, lng) {
      const tol = 0.00005;
      return Math.abs(lat - targetRestaurant.lat) <= tol &&
             Math.abs(lng - targetRestaurant.lng) <= tol;
    }

    function showWin() {
      winPlace.textContent = targetRestaurant.name + " ‚Äì Yokohama, Japan";
      winOverlay.style.display = "flex";
    }

    function sanitizeDigits(el) {
      el.value = el.value.replace(/[^\d]/g, "");
    }
    latPrefixEl.addEventListener("input", () => sanitizeDigits(latPrefixEl));
    lngPrefixEl.addEventListener("input", () => sanitizeDigits(lngPrefixEl));

    searchBtn.addEventListener("click", () => {
      if (giftFound) return;

      const latPrefix = (latPrefixEl.value || "").trim();
      const lngPrefix = (lngPrefixEl.value || "").trim();

      if (!/^\d{2}$/.test(latPrefix) || !/^\d{3}$/.test(lngPrefix)) {
        setResult(
          "bad",
          "Input not complete",
          "Latitude needs 2 digits; Longitude needs 3 digits.",
          false
        );
        return;
      }

      const lat = parseFloat(`${latPrefix}.442006`);
      const lng = parseFloat(`${lngPrefix}.630649`);

      clearGuessMarker();

      if (isCorrectGuess(lat, lng)) {
        const ll = L.latLng(lat, lng);
        map.setView(ll, 18);

        activeGuessMarker = L.marker(ll, { icon: makeGuessIcon(true) }).addTo(map);

        setResult(
          "good",
          "Correct! Memory located.",
          `${targetRestaurant.name} ‚Äî you found the true coordinates.`,
          true
        );

        giftFound = true;
        playWinSound();
        lockMap();
        showWin();
      } else {
        const rnd = randomLatLngNotNear(targetRestaurant.lat, targetRestaurant.lng);
        const ll = L.latLng(rnd.lat, rnd.lng);
        map.setView(ll, 5);

        activeGuessMarker = L.marker(ll, { icon: makeGuessIcon(false) }).addTo(map);

        setResult(
          "bad",
          "Not quite‚Ä¶",
          "That coordinate leads somewhere else. Try again and search again!",
          false
        );
      }
    });
  </script>
</body>
</html>
