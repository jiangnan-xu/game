<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Level 33 memory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Shippori+Mincho:wght@500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --title-font: "Shippori Mincho", serif;
  --ui-font: "Inter", "Zen Maru Gothic", system-ui, sans-serif;
}

html,body{
  margin:0; padding:0; height:100%;
  background:#000;
  overflow:hidden;
  font-family:var(--ui-font);
}

#intro{ position:fixed; inset:0; background:#000; }

/* ===== Title ===== */
#title-layer{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  text-align:center; color:#fff;
  z-index:10; pointer-events:none;
  transition:opacity .55s ease;
  background:
    radial-gradient(circle at 50% 35%, rgba(255,255,255,.10), rgba(0,0,0,.93) 65%);
}
.title-wrap{ max-width:820px; padding:24px; }
.kicker{ letter-spacing:.35em; font-size:12px; opacity:.70; margin-bottom:16px; }
.title{
  font-family:var(--title-font);
  font-size:clamp(44px,6vw,72px);
  font-weight:700;
  line-height:1.05;
  text-shadow:0 20px 90px rgba(0,0,0,.85);
}
.subtitle{
  margin-top:14px;
  font-size:14px;
  opacity:.82;
  letter-spacing:.02em;
}
.subhint{
  margin-top:18px;
  font-size:12px;
  opacity:.65;
  letter-spacing:.18em;
}

/* ===== Scene ===== */
#scene{
  position:absolute; inset:0;
  opacity:0;
  transition:opacity .65s ease;
}

/* Transform this layer so everything stays aligned */
#camera{
  position:absolute; inset:0;
  transform-origin: 50% 50%;
  will-change: transform;
}

#scene-img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

/* Hotspots are invisible */
.hotspot{
  position:absolute;
  border:none;
  background:transparent;
  cursor:pointer;
  z-index:4;
  opacity:0;            /* disabled until lock level */
  pointer-events:none;
  transition: opacity .25s ease;
}
.hotspot.enabled{
  opacity:1;            /* still invisible, but clickable */
  pointer-events:auto;
}

/* Optional: only show a subtle outline on hover (desktop) */
.hotspot.enabled:hover{
  outline: 1px solid rgba(255,255,255,0.10);
  border-radius: 16px;
}

/* Tiny bell indicator (not a big glow) */
#bell-indicator{
  position:absolute;
  transform: translate(-50%,-50%);
  z-index:5;
  pointer-events:none;
  opacity:0;
  transition: opacity .25s ease;
  color: rgba(255,255,255,0.85);
  font-size: 14px;
  text-shadow: 0 10px 30px rgba(0,0,0,0.55);
}
#bell-indicator.enabled{ opacity:1; }

/* ===== Lock panel (on door) ===== */
#door-lock{
  position:absolute;
  z-index:7;
  display:none;
  width: min(320px, 76vw);
  padding: 12px 12px 10px;
  border-radius: 16px;
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(255,255,255,.45);
  box-shadow: 0 26px 80px rgba(0,0,0,.46);
  backdrop-filter: blur(10px);
}
#door-lock.show{ display:block; }

.lock-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}
.lock-title{
  font-family:"Zen Maru Gothic", var(--ui-font);
  font-weight:900;
  font-size:14px;
  color:#111827;
}
.lock-close{
  width:32px;height:32px;
  border-radius:999px;
  border: 1px solid rgba(17,24,39,.10);
  background: rgba(17,24,39,.05);
  cursor:pointer;
  font-weight:900;
}
.lock-sub{ font-size:12px; color:#374151; margin-bottom:8px; }

.lock-wheels{
  display:flex; justify-content:center;
  gap:10px; margin: 8px 0 8px;
}
.wheel{
  width:42px; height:64px;
  border-radius:14px;
  background:linear-gradient(#eef2ff,#dbeafe);
  border:1px solid #bfdbfe;
  display:flex; align-items:center; justify-content:center;
  font-family:"Zen Maru Gothic"; font-size:22px; font-weight:900;
  cursor:grab; user-select:none;
}
.unlock-btn{
  width:100%;
  padding:9px 12px;
  border-radius:999px;
  border:none;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(135deg,#fde68a,#fb923c);
}
.hint-message{ margin-top:8px; color:#b91c1c; font-weight:900; min-height:16px; font-size:12px; }

/* ===== NPC Dialogue (bottom) ===== */
#npc-layer{
  position:absolute;
  left:0; right:0; bottom:0;
  z-index:20;
  pointer-events:none;
  opacity:0;
  transform: translateY(12px);
  transition: opacity .35s ease, transform .35s ease;
}
#npc-layer.enabled{
  opacity:1;
  transform: translateY(0);
}

.npc-box{
  margin: 0 auto 18px;
  width: min(760px, 92vw);
  border-radius: 18px;
  padding: 14px 16px 12px;
  color: rgba(255,255,255,0.92);
  background: rgba(0,0,0,0.46);
  border: 1px solid rgba(255,255,255,0.14);
  box-shadow: 0 26px 90px rgba(0,0,0,0.50);
  backdrop-filter: blur(10px);
}

.npc-name{
  font-family: "Zen Maru Gothic", var(--ui-font);
  font-weight: 900;
  font-size: 12px;
  letter-spacing: .10em;
  opacity: .88;
  margin-bottom: 6px;
}

.npc-text{
  font-size: 14px;
  line-height: 1.65;
}

.npc-hintline{
  margin-top: 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  opacity: .78;
  font-size: 12px;
  letter-spacing: .06em;
}

.npc-dots{
  display:flex; gap:6px;
}
.dot{
  width:6px;height:6px;border-radius:999px;
  background: rgba(255,255,255,0.22);
}
.dot.on{ background: rgba(255,255,255,0.75); }

/* Toast (top) */
#toast{
  position:absolute;
  left:50%; top: 18px;
  transform:translateX(-50%);
  padding:10px 14px;
  background:rgba(0,0,0,.60);
  color:#fff;
  border-radius:999px;
  font-size:14px;
  opacity:0;
  transition:.2s;
  z-index:30;
  pointer-events:none;
}
#toast.show{ opacity:1; transform:translate(-50%, -6px); }
</style>
</head>

<body>
<div id="intro">

  <div id="title-layer">
    <div class="title-wrap">
      <div class="kicker">LEVEL 33</div>
      <div class="title">memory</div>
      <div class="subtitle">Scroll to approach.</div>
      <div class="subhint">â†“</div>
    </div>
  </div>

  <div id="scene">
    <div id="camera">
      <img id="scene-img" src="door-bg.jpg" alt="Door hallway background"/>

      <button id="door-hotspot" class="hotspot" aria-label="Door"></button>
      <button id="bell-hotspot" class="hotspot" aria-label="Doorbell"></button>

      <div id="bell-indicator" aria-hidden="true">ðŸ””</div>

      <div id="door-lock" aria-hidden="true">
        <div class="lock-top">
          <div class="lock-title">Locked.</div>
          <button id="lock-close" class="lock-close" aria-label="Close">âœ•</button>
        </div>
        <div class="lock-sub">Enter the first code.</div>
        <div class="lock-wheels" id="lock-wheels"></div>
        <button class="unlock-btn" id="unlock-btn">Unlock</button>
        <div class="hint-message" id="hint-message"></div>
      </div>
    </div>

    <!-- NPC dialogue appears only after reaching the locked zoom level -->
    <div id="npc-layer" aria-hidden="true">
      <div class="npc-box">
        <div class="npc-name" id="npc-name">NPC</div>
        <div class="npc-text" id="npc-text"></div>
        <div class="npc-hintline">
          <span id="npc-scrollhint">Scroll to continueâ€¦</span>
          <span class="npc-dots" id="npc-dots"></span>
        </div>
      </div>
    </div>

    <div id="toast" role="status" aria-live="polite"></div>
  </div>
</div>

<audio id="song" src="song.m4a" preload="auto"></audio>

<script>
/* ===================== CONFIG ===================== */
const CFG = {
  code: "MEMORY",                 // change freely
  focus: { x: 0.44, y: 0.52 },     // zoom focus point (door)
  zoomMin: 1.0,
  zoomMax: 1.85,

  // Once progress hits 1, it locks forever (no zoom down again)
  lockProgress: 1.0,

  // Hotspot rects (normalized in camera coords)
  door: { x: 0.34, y: 0.18, w: 0.28, h: 0.66 },
  bell: { x: 0.60, y: 0.46, w: 0.06, h: 0.09 }, // put above the white switch
  lock: { x: 0.50, y: 0.44 },
  bellIndicator: { x: 0.60, y: 0.45 },

  npc: {
    name: "???",
    lines: [
      "â€¦You finally made it.",
      "Two things here: the bell, and the door.",
      "Try the bell first. It might reveal what the eyes canâ€™t.",
      "Then touch the door. If it wonâ€™t openâ€¦ youâ€™ll need the first code."
    ]
  }
};

/* ===================== ELEMENTS ===================== */
const scene = document.getElementById("scene");
const titleLayer = document.getElementById("title-layer");
const camera = document.getElementById("camera");

const doorBtn = document.getElementById("door-hotspot");
const bellBtn = document.getElementById("bell-hotspot");
const bellIndicator = document.getElementById("bell-indicator");

const lockPanel = document.getElementById("door-lock");
const lockClose = document.getElementById("lock-close");
const wheelsEl = document.getElementById("lock-wheels");
const unlockBtn = document.getElementById("unlock-btn");
const hintMsg = document.getElementById("hint-message");

const npcLayer = document.getElementById("npc-layer");
const npcNameEl = document.getElementById("npc-name");
const npcTextEl = document.getElementById("npc-text");
const npcDotsEl = document.getElementById("npc-dots");

const toast = document.getElementById("toast");
const song = document.getElementById("song");

/* ===================== STATE ===================== */
let progress = 0;             // 0..1 zoom approach
let cameraLocked = false;     // becomes true once reached
let lockOpen = false;
let npcIndex = 0;

/* ===================== HELPERS ===================== */
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 900);
}

function setRect(el, r){
  el.style.left   = (r.x * 100) + "%";
  el.style.top    = (r.y * 100) + "%";
  el.style.width  = (r.w * 100) + "%";
  el.style.height = (r.h * 100) + "%";
}
function setPoint(el, p){
  el.style.left = (p.x * 100) + "%";
  el.style.top  = (p.y * 100) + "%";
  el.style.transform = "translate(-50%, -50%)";
}

function enableLockedUI(on){
  doorBtn.classList.toggle("enabled", on);
  bellBtn.classList.toggle("enabled", on);
  bellIndicator.classList.toggle("enabled", on);

  npcLayer.classList.toggle("enabled", on);
  npcLayer.setAttribute("aria-hidden", (!on).toString());
}

function renderNPC(){
  npcNameEl.textContent = CFG.npc.name;
  npcTextEl.textContent = CFG.npc.lines[npcIndex];

  npcDotsEl.innerHTML = "";
  for(let i=0; i<CFG.npc.lines.length; i++){
    const d = document.createElement("div");
    d.className = "dot" + (i === npcIndex ? " on" : "");
    npcDotsEl.appendChild(d);
  }
}

/* ===================== CAMERA ===================== */
function applyCamera(){
  const show = clamp01((progress - 0.10) / 0.30);
  scene.style.opacity = show.toFixed(3);
  titleLayer.style.opacity = (1 - show).toFixed(3);

  const t = clamp01(progress);
  const zoom = CFG.zoomMin + (CFG.zoomMax - CFG.zoomMin) * (t * t);

  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const dx = (0.5 - CFG.focus.x) * vw * (zoom - 1);
  const dy = (0.5 - CFG.focus.y) * vh * (zoom - 1);

  camera.style.transform = `translate(${dx}px, ${dy}px) scale(${zoom})`;
}

function lockCameraIfReached(){
  if (cameraLocked) return;
  if (progress >= CFG.lockProgress){
    progress = CFG.lockProgress;
    cameraLocked = true;
    enableLockedUI(true);
    renderNPC();
    showToast("â€¦");
  }
}

/* Position UI in camera coords */
setRect(doorBtn, CFG.door);
setRect(bellBtn, CFG.bell);
setPoint(lockPanel, CFG.lock);
setPoint(bellIndicator, CFG.bellIndicator);

enableLockedUI(false);
applyCamera();

window.addEventListener("resize", applyCamera);

/* ===================== SCROLL LOGIC ===================== */
/*
  Phase A (not locked): scroll ONLY moves toward locked level (no zoom down again)
  Phase B (locked): scroll cycles NPC dialogue (no zoom)
*/
window.addEventListener("wheel", (e) => {
  e.preventDefault();

  if (!cameraLocked){
    // Only allow zooming IN:
    // wheel down (deltaY>0) increases progress, wheel up does nothing
    if (e.deltaY > 0){
      progress = clamp01(progress + e.deltaY * 0.0007);
      applyCamera();
      lockCameraIfReached();
    }
    return;
  }

  // Camera locked: scroll cycles NPC lines (but not while lock UI is open)
  if (lockOpen) return;

  if (e.deltaY > 0){
    npcIndex = Math.min(CFG.npc.lines.length - 1, npcIndex + 1);
  } else {
    npcIndex = Math.max(0, npcIndex - 1);
  }
  renderNPC();
}, { passive:false });

/* ===================== INTERACTIONS ===================== */
bellBtn.addEventListener("click", () => {
  showToast("ðŸ””");
  try{
    song.currentTime = 0;
    song.play().catch(()=>{});
  }catch(_){}
});

function openLock(){
  lockOpen = true;
  lockPanel.classList.add("show");
  lockPanel.setAttribute("aria-hidden", "false");
  hintMsg.textContent = "";
}
function closeLock(){
  lockOpen = false;
  lockPanel.classList.remove("show");
  lockPanel.setAttribute("aria-hidden", "true");
  hintMsg.textContent = "";
}

doorBtn.addEventListener("click", () => {
  showToast("The door is closed.");
  openLock();
});

lockClose.addEventListener("click", closeLock);
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && lockOpen) closeLock();
});

// click outside lock panel closes it
camera.addEventListener("pointerdown", (e) => {
  if (!lockOpen) return;
  if (!lockPanel.contains(e.target)) closeLock();
});

/* ===================== LOCK WHEELS ===================== */
const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const CODE = CFG.code.toUpperCase();
const wheelState = new Array(CODE.length).fill(0);

function buildWheels(){
  wheelsEl.innerHTML = "";
  for(let i=0; i<CODE.length; i++){
    const w = document.createElement("div");
    w.className = "wheel";
    w.textContent = letters[wheelState[i]];

    w.addEventListener("wheel", (e) => {
      e.preventDefault();
      const dir = (e.deltaY > 0) ? -1 : 1;
      wheelState[i] = (wheelState[i] + dir + 26) % 26;
      w.textContent = letters[wheelState[i]];
    }, { passive:false });

    wheelsEl.appendChild(w);
  }
}
function enteredCode(){ return wheelState.map(i => letters[i]).join(""); }

buildWheels();

unlockBtn.addEventListener("click", () => {
  if (enteredCode() === CODE){
    showToast("Unlocked.");
    closeLock();
    // Hook next scene here
    // document.getElementById("intro").style.display = "none";
  } else {
    hintMsg.textContent = "Not quiteâ€¦";
  }
});
</script>
</body>
</html>
