<!-- ====== OPENING / DOOR / LOCK / SONG (drop-in section) ====== -->

<div id="intro">
  <div class="intro-title">
    <div class="intro-sub">GAME TITLE</div>
    <div class="intro-main">Level 33 memory</div>
    <div class="intro-hint">Scroll to begin</div>
  </div>

  <div id="scene">
    <img id="scene-img" src="door-bg.jpg" alt="Door scene" />

    <!-- Hotspots (positions are %; tune to match your image precisely) -->
    <button id="door-hotspot" class="hotspot" aria-label="Door"></button>
    <button id="ring-hotspot" class="hotspot ring" aria-label="Ring / Doorbell"></button>

    <!-- Small toast message -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <!-- Lock popup -->
  <div id="lock-modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-title">The door is closed.</div>
      <div class="modal-sub">Enter the first reality code.</div>

      <div class="audio-row">
        <button id="ring-btn" class="ring-btn">ðŸ”” Ring (play song)</button>
      </div>

      <div id="lock-wheels" class="lock-wheels"></div>

      <div class="modal-actions">
        <button id="unlock-btn" class="btn-primary">Unlock</button>
        <button id="close-modal" class="btn-ghost">Close</button>
      </div>

      <div id="hint-message" class="hint-message"></div>
    </div>
  </div>
</div>

<audio id="hint-audio" src="song.m4a" preload="auto"></audio>

<style>
  /* Fullscreen black opening */
  #intro{
    position: fixed;
    inset: 0;
    background: #000;
    overflow: hidden;
    z-index: 9999;
    font-family: "Nunito", system-ui, sans-serif;
  }

  .intro-title{
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    color:#fff;
    text-align:center;
    pointer-events:none;
    transition: opacity 300ms ease;
  }
  .intro-sub{ letter-spacing:.25em; opacity:.75; font-size:12px; margin-bottom:10px; }
  .intro-main{ font-family:"Zen Maru Gothic", system-ui, sans-serif; font-size:44px; font-weight:800; }
  .intro-hint{ margin-top:14px; font-size:14px; opacity:.75; }

  /* Scene container (revealed by scroll) */
  #scene{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity: 0;                 /* revealed by scroll */
    transition: opacity 400ms ease;
  }

  /* We transform the image for zoom/pan */
  #scene-img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform-origin: 50% 50%;
    will-change: transform;
    user-select:none;
    -webkit-user-drag:none;
  }

  /* Hotspots (in % relative to viewport; adjust) */
  .hotspot{
    position:absolute;
    border:none;
    background: rgba(255,255,255,0);
    cursor: pointer;
  }

  /* Door area â€” tune these */
  #door-hotspot{
    left: 34%;
    top: 18%;
    width: 28%;
    height: 66%;
  }

  /* Doorbell / ring â€” tune these */
  #ring-hotspot{
    left: 56%;
    top: 43%;
    width: 6%;
    height: 10%;
  }

  /* Optional: show hotspot when debugging */
  /* .hotspot{ outline: 2px dashed rgba(255,255,255,0.35); } */

  .toast{
    position:absolute;
    left:50%;
    bottom: 40px;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.65);
    color:#fff;
    padding: 10px 14px;
    border-radius: 999px;
    font-size: 14px;
    opacity: 0;
    pointer-events:none;
    transition: opacity 180ms ease, transform 180ms ease;
  }
  .toast.show{
    opacity: 1;
    transform: translateX(-50%) translateY(-6px);
  }

  /* Modal */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(4px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 10000;
  }
  .modal.show{ display:flex; }

  .modal-card{
    width: min(520px, 92vw);
    border-radius: 20px;
    background: rgba(255,255,255,0.96);
    border: 1px solid rgba(255,255,255,0.25);
    box-shadow: 0 30px 90px rgba(0,0,0,0.45);
    padding: 18px 18px 16px;
    text-align:center;
  }
  .modal-title{
    font-family:"Zen Maru Gothic", system-ui, sans-serif;
    font-weight: 800;
    font-size: 18px;
    color:#111827;
    margin-bottom: 6px;
  }
  .modal-sub{
    font-size: 14px;
    color:#374151;
    margin-bottom: 12px;
  }

  .audio-row{ display:flex; justify-content:center; margin: 8px 0 10px; }
  .ring-btn{
    border:none;
    border-radius: 999px;
    padding: 10px 14px;
    cursor:pointer;
    font-weight: 800;
    background: linear-gradient(135deg, #93c5fd, #fbcfe8);
  }

  .modal-actions{
    display:flex;
    gap:10px;
    justify-content:center;
    margin-top: 14px;
    flex-wrap:wrap;
  }
  .btn-primary{
    border:none;
    border-radius: 999px;
    padding: 10px 18px;
    cursor:pointer;
    font-weight: 900;
    background: linear-gradient(135deg, #fde68a, #fb923c);
  }
  .btn-ghost{
    border: 1px solid rgba(17,24,39,0.15);
    border-radius: 999px;
    padding: 10px 18px;
    cursor:pointer;
    font-weight: 900;
    background: rgba(255,255,255,0.75);
  }

  /* Wheels (kept close to your original) */
  .lock-wheels{
    display:flex;
    justify-content:center;
    gap:12px;
    margin: 10px 0 6px;
    user-select:none;
    -webkit-user-select:none;
    touch-action: pan-y;
  }
  .wheel{
    width: 54px;
    height: 78px;
    border-radius: 16px;
    background: linear-gradient(180deg, #eff6ff 0, #dbeafe 100%);
    border: 1px solid #bfdbfe;
    box-shadow: 0 12px 26px rgba(148,163,184,0.55);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
    cursor: grab;
  }
  .wheel:active{ cursor: grabbing; }
  .wheel::before, .wheel::after{
    content:"";
    position:absolute;
    left:0; right:0;
    height: 22px;
    pointer-events:none;
  }
  .wheel::before{ top:0; background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0)); }
  .wheel::after { bottom:0; background: linear-gradient(0deg, rgba(255,255,255,0.95), rgba(255,255,255,0)); }
  .wheel .window-line{
    position:absolute;
    left:8px; right:8px;
    height: 2px;
    top: 50%;
    transform: translateY(-1px);
    background: rgba(59,130,246,0.25);
    border-radius: 999px;
    pointer-events:none;
  }
  .wheel-letter{
    font-family: "Zen Maru Gothic", system-ui, sans-serif;
    font-size: 26px;
    font-weight: 800;
    color:#111827;
    transition: transform 0.06s ease;
    will-change: transform;
  }

  .hint-message{
    margin-top: 10px;
    min-height: 18px;
    font-weight: 900;
    color: #b91c1c;
  }
</style>

<script>
  // ========= CONFIG =========
  const CORRECT_CODE = "REALITY";
  const NUM_WHEELS = 7;
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

  // Zoom target: where the camera should end up (door center) in normalized coords (0..1)
  // Tune these to match your door location in the image.
  const DOOR_FOCUS = { x: 0.44, y: 0.52 };   // center-ish on door
  const ZOOM_MIN = 1.0;
  const ZOOM_MAX = 2.6;

  // ========= ELEMENTS =========
  const introTitle = document.querySelector(".intro-title");
  const scene = document.getElementById("scene");
  const sceneImg = document.getElementById("scene-img");

  const doorHotspot = document.getElementById("door-hotspot");
  const ringHotspot = document.getElementById("ring-hotspot");
  const toast = document.getElementById("toast");

  const modal = document.getElementById("lock-modal");
  const closeModalBtn = document.getElementById("close-modal");
  const unlockBtn = document.getElementById("unlock-btn");
  const hintMessage = document.getElementById("hint-message");

  const ringBtn = document.getElementById("ring-btn");
  const hintAudio = document.getElementById("hint-audio");

  const lockWheelsContainer = document.getElementById("lock-wheels");

  // ========= TOAST =========
  let toastT = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toastT);
    toastT = setTimeout(() => toast.classList.remove("show"), 900);
  }

  // ========= SCROLL-TO-REVEAL + ZOOM =========
  let progress = 0; // 0..1
  let rafPending = false;

  function clamp01(v){ return Math.max(0, Math.min(1, v)); }

  function applyCamera(){
    // fade from black title -> scene
    const sceneAlpha = clamp01((progress - 0.05) / 0.25);
    scene.style.opacity = sceneAlpha.toFixed(3);
    introTitle.style.opacity = (1 - sceneAlpha).toFixed(3);

    // zoom curve
    const t = clamp01((progress - 0.10) / 0.90);
    const zoom = ZOOM_MIN + (ZOOM_MAX - ZOOM_MIN) * (t * t); // ease in

    // pan so that DOOR_FOCUS sits at center
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const offsetX = (0.5 - DOOR_FOCUS.x) * vw * (zoom - 1);
    const offsetY = (0.5 - DOOR_FOCUS.y) * vh * (zoom - 1);

    sceneImg.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${zoom})`;
  }

  function requestApply(){
    if (rafPending) return;
    rafPending = true;
    requestAnimationFrame(() => {
      rafPending = false;
      applyCamera();
    });
  }

  window.addEventListener("wheel", (e) => {
    // scroll controls progress
    e.preventDefault();
    const delta = -e.deltaY;              // wheel down -> negative
    progress = clamp01(progress + delta * 0.0007);
    requestApply();
  }, { passive: false });

  window.addEventListener("resize", requestApply);
  applyCamera();

  // ========= MODAL OPEN/CLOSE =========
  function openModal(){
    modal.classList.add("show");
    modal.setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden", "true");
  }
  closeModalBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });

  // ========= AUDIO (ring click required) =========
  function playSong(){
    try{
      hintAudio.currentTime = 0;
      hintAudio.play().catch(()=>{});
    }catch(_){}
  }
  ringHotspot.addEventListener("click", () => {
    showToast("ðŸ”” Ring...");
    playSong();
  });
  ringBtn.addEventListener("click", () => {
    showToast("ðŸŽµ Playing song");
    playSong();
  });

  // ========= DOOR CLICK =========
  doorHotspot.addEventListener("click", () => {
    showToast("The door is closed.");
    openModal();
  });

  // ========= LETTER LOCK (your wheel logic, compact) =========
  const wheelPositions = new Array(NUM_WHEELS).fill(0);

  function clampWheel(i){
    if (i < 0) return letters.length - 1;
    if (i >= letters.length) return 0;
    return i;
  }
  function getEnteredCode(){
    return wheelPositions.map((pos) => letters[pos]).join("");
  }
  function showLockMessage(text){
    hintMessage.textContent = text;
  }

  function createScrollWheel(index){
    const wheel = document.createElement("div");
    wheel.className = "wheel";

    const windowLine = document.createElement("div");
    windowLine.className = "window-line";

    const letterEl = document.createElement("div");
    letterEl.className = "wheel-letter";
    letterEl.textContent = letters[wheelPositions[index]];

    function step(direction){
      wheelPositions[index] = clampWheel(wheelPositions[index] + direction);
      letterEl.textContent = letters[wheelPositions[index]];
      letterEl.style.transform = `translateY(${direction > 0 ? -8 : 8}px)`;
      setTimeout(() => (letterEl.style.transform = "translateY(0)"), 60);
    }

    wheel.addEventListener("wheel", (e) => {
      e.preventDefault();
      const direction = e.deltaY > 0 ? -1 : 1;
      step(direction);
    }, { passive:false });

    const STEP_PX = 14;
    let dragging = false, lastY = 0, accumulatedDy = 0;

    wheel.addEventListener("pointerdown", (e) => {
      dragging = true;
      wheel.setPointerCapture(e.pointerId);
      lastY = e.clientY;
      accumulatedDy = 0;
      e.preventDefault();
    });

    wheel.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      e.preventDefault();
      const dy = e.clientY - lastY;
      lastY = e.clientY;
      accumulatedDy += dy;

      while (accumulatedDy <= -STEP_PX) { step(+1); accumulatedDy += STEP_PX; }
      while (accumulatedDy >=  STEP_PX) { step(-1); accumulatedDy -= STEP_PX; }
    });

    function endDrag(){ dragging = false; accumulatedDy = 0; }
    wheel.addEventListener("pointerup", endDrag);
    wheel.addEventListener("pointercancel", endDrag);
    wheel.addEventListener("pointerleave", endDrag);

    wheel.appendChild(windowLine);
    wheel.appendChild(letterEl);
    return wheel;
  }

  // init wheels once
  lockWheelsContainer.innerHTML = "";
  for (let i=0; i<NUM_WHEELS; i++){
    lockWheelsContainer.appendChild(createScrollWheel(i));
  }

  // unlock check
  unlockBtn.addEventListener("click", () => {
    const entered = getEnteredCode();
    if (entered === CORRECT_CODE){
      showLockMessage("");
      closeModal();
      showToast("Unlocked.");
      // Next step (map) should start after this â€” youâ€™ll hook it here.
      // Example: document.getElementById("hint-overlay").style.display = "none";
      // Or: intro can fade out: document.getElementById("intro").style.display = "none";
    } else {
      showLockMessage("Not quiteâ€¦");
    }
  });
</script>
